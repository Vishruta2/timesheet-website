<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timesheet Data</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f2f2f2; font-size: 18px; }
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 64px;
            background: #090426;
            box-shadow: 0 2px 8px rgba(66,133,244,0.08);
            display: flex;
            align-items: center;
            justify-content: flex-start;
            z-index: 20;
        }
        .navbar-logo {
            height: 48px;
            width: auto;
            margin-right: 40px;
        }
        .container { width: 90%; margin: 40px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px #ccc; margin-top: 90px; }
        h2 { text-align: center; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; font-size: 18px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #4285f4; color: #fff; }
        tr:nth-child(even) { background: #f9f9f9; }
        #downloadPdfBtn {
            position: absolute;
            top: 16px !important;
            right: 40px;
            padding: 8px 20px;
            font-size: 15px;
            background: #4285f4;
            color: #fff;
            border: none;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(66,133,244,0.10);
            cursor: pointer;
            font-weight: bold;
            letter-spacing: 0.5px;
            transition: background 0.3s, transform 0.2s;
            z-index: 30;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <img src="logo.png" alt="Logo" class="navbar-logo">
    </div>
    <div class="container">
        <h2 id="sheetTitle">Employee Timesheet</h2>
        <button id="downloadPdfBtn"
            style="
                margin-bottom: 20px;
                position: static;
                display: block;
                float: right;
                top: auto;
                right: auto;
            "
            onmouseover="this.style.background='#3367d6'; this.style.transform='scale(1.05)';"
            onmouseout="this.style.background='#4285f4'; this.style.transform='scale(1)';"
        >
            ‚¨áÔ∏è Download
        </button>

        <div id="tableContainer">Loading timesheet...</div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        const SHEET_ID = '1_-ZPknnR0N_-iIekrmQE9nKU7Lu2FAA2SQqf2ZXCpYY';
        const RANGE = 'Form Responses 1'; // or 'Sheet1!A1:H'
        const API_KEY = 'AIzaSyBkZ9IVxc5e0s_PJb0ViznAVWUAP-byDWg';

        // Configuration for columns: which to show and their display names
        // The order in this array determines the display order
        const COLUMN_CONFIG = [
            { key: 'Serial', label: 'Serial Number', show: true },
            { key: 'üë§ Choose Your Name ', label: 'Name', show: true },
            { key: 'üìÜ Choose Date', label: 'Date', show: true },
            { key: 'üìÅ Choose Project Code', label: 'Project Code', show: true },
            { key: '‚è∞ Choose Task Start Time', label: 'Start time', show: true },
            { key: '‚è∞ Choose Task End Time', label: 'End Time', show: true },
            { key: 'Hours worked', label: 'Hours worked', show: true },
            { key: 'üè¢ Work Mode', label: 'Mode', show: true },
            // Add more columns here if needed
        ];

        // Remove the fetch for spreadsheet metadata and setting of sheetTitle

        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(RANGE)}?key=${API_KEY}`;

        let allRows = [];
        let filters = {};

        // Helper to normalize date to YYYY-MM-DD
        function normalizeDate(str) {
            if (!str) return '';
            const parts = str.split('/');
            if (parts.length === 3) {
                let [m, d, y] = parts;
                if (y.length === 4) {
                    if (Number(m) > 12) [d, m] = [m, d];
                    return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
                }
            }
            return str;
        }

        function renderTable(rows, filters = {}) {
            if (!rows || rows.length === 0) {
                document.getElementById('tableContainer').innerHTML = 'No data found or data format incorrect.';
                return;
            }

            // Find indices of columns to show (excluding 'Timestamp')
            const headerRow = rows[0];
            const colIndices = COLUMN_CONFIG.filter(col => col.key !== 'Serial' && col.show)
                .map(col => headerRow.indexOf(col.key));

            // Apply filters (skip Serial column)
            let filteredRows = rows.slice(1).filter((row, rowIdx) =>
                colIndices.every((colIdx, i) => {
                    const filterVal = filters[colIdx];
                    const startDateFilter = filters[colIdx + '_start'];
                    const endDateFilter = filters[colIdx + '_end'];
                    
                    if (headerRow[colIdx] === 'üìÜ Choose Date') {
                        // Handle date range filtering
                        if (startDateFilter || endDateFilter) {
                            const rowDate = normalizeDate(row[colIdx]);
                            if (!rowDate) return false;
                            
                            const rowDateObj = new Date(rowDate);
                            if (isNaN(rowDateObj.getTime())) return false;
                            
                            if (startDateFilter) {
                                const startDate = new Date(startDateFilter);
                                if (rowDateObj < startDate) return false;
                            }
                            
                            if (endDateFilter) {
                                const endDate = new Date(endDateFilter);
                                if (rowDateObj > endDate) return false;
                            }
                            
                            return true;
                        } else if (filterVal) {
                            // Handle single date filter (backward compatibility)
                            return normalizeDate(row[colIdx]) === filterVal;
                        }
                        return true;
                    }
                    
                    // Handle other column filters
                    if (!filterVal) return true;
                    return row[colIdx] === filterVal;
                })
            );

            let html = '<table><thead><tr>';
            // Render dropdown filters and headers
            COLUMN_CONFIG.forEach((col, i) => {
                if (!col.show) return;
                if (col.key === 'Serial') {
                    html += `<th><div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>${col.label}</span>
                                <span></span>
                             </div></th>`;
                } else if (col.key === 'üìÜ Choose Date') {
                    const colIdx = headerRow.indexOf(col.key);
                    const startDateFilter = filters[colIdx + '_start'] || '';
                    const endDateFilter = filters[colIdx + '_end'] || '';
                    html += `<th>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <span>${col.label}</span>
                            <div style="display: flex; gap: 4px; font-size: 12px;">
                                <input type="date" placeholder="Start Date" style="width: 100px; padding: 2px; font-size: 11px;" 
                                       onchange="applyDateRangeFilter(${colIdx}, this.value, 'start')" value="${startDateFilter}">
                                <input type="date" placeholder="End Date" style="width: 100px; padding: 2px; font-size: 11px;" 
                                       onchange="applyDateRangeFilter(${colIdx}, this.value, 'end')" value="${endDateFilter}">
                            </div>
                        </div>
                    </th>`;
                } else if (col.key === '‚è∞ Choose Task Start Time' || col.key === '‚è∞ Choose Task End Time' || col.key === 'Hours worked') {
                    html += `<th><div style=\"display: flex; justify-content: space-between; align-items: center;\"><span>${col.label}</span></div></th>`;
                } else {
                    const colIdx = headerRow.indexOf(col.key);
                    const uniqueVals = [...new Set(rows.slice(1).map(row => row[colIdx] || ''))];
                    html += `<th>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${col.label}</span>
                            <select style="margin-left: 8px;" onchange="applyFilter(${colIdx}, this.value)">
                                <option value=""${!filters[colIdx] ? ' selected' : ''}>All</option>
                                ${uniqueVals.map(val =>
                                    `<option value="${val}"${filters[colIdx] === val ? ' selected' : ''}>${val}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </th>`;
                }
            });
            html += '</tr></thead><tbody>';

            // Render filtered rows
            filteredRows.forEach((row, i) => {
                html += '<tr>';
                COLUMN_CONFIG.forEach(col => {
                    if (!col.show) return;
                    if (col.key === 'Serial') {
                        html += `<td>${i + 1}</td>`;
                    } else if (col.key === 'Hours worked') {
                        const startIdx = headerRow.indexOf('‚è∞ Choose Task Start Time');
                        const endIdx = headerRow.indexOf('‚è∞ Choose Task End Time');
                        const start = row[startIdx] || '';
                        const end = row[endIdx] || '';

                        function parseTime12h(t) {
                            // Parse time in 12-hour format (e.g., 9:00:00 AM)
                            const [time, modifier] = t.split(' ');
                            let [hours, minutes, seconds] = time.split(':').map(Number);
                            if (modifier === 'PM' && hours !== 12) hours += 12;
                            if (modifier === 'AM' && hours === 12) hours = 0;
                            return hours * 60 + minutes + (seconds ? seconds / 60 : 0);
                        }

                        let total = '';
                        if (start && end) {
                            const startMins = parseTime12h(start);
                            const endMins = parseTime12h(end);
                            let diffMins = endMins - startMins;
                            if (diffMins < 0) diffMins += 24 * 60; // handle overnight
                            const hours = Math.floor(diffMins / 60);
                            const mins = Math.round(diffMins % 60);
                            total = hours + (mins > 0 ? (':' + mins.toString().padStart(2, '0')) : '');
                        }
                        html += `<td>${total}</td>`;
                    } else {
                        const colIdx = headerRow.indexOf(col.key);
                        html += `<td>${row[colIdx]}</td>`;
                    }
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            document.getElementById('tableContainer').innerHTML = html;
        }

        window.applyFilter = function(colIdx, value) {
            filters[colIdx] = value;
            renderTable(allRows, filters);
        };

        window.applyDateRangeFilter = function(colIdx, value, type) {
            if (type === 'start') {
                filters[colIdx + '_start'] = value;
            } else if (type === 'end') {
                filters[colIdx + '_end'] = value;
            }
            renderTable(allRows, filters);
        };

        fetch(url)
            .then(response => response.json())
            .then(data => {
                allRows = data.values;
                filters = {}; // Reset filters
                renderTable(allRows, filters);
            })
            .catch(err => {
                document.getElementById('tableContainer').innerHTML = 'Error loading timesheet: ' + err.message;
            });

    document.getElementById('downloadPdfBtn').addEventListener('click', function() {
        // Capture the entire page including navbar and logo
        html2canvas(document.body, {
            allowTaint: true,
            useCORS: true,
            scale: 2,
            backgroundColor: '#f2f2f2'
        }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new window.jspdf.jsPDF({
                orientation: 'landscape',
                unit: 'pt',
                format: 'a4'
            });
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = pageWidth - 40;
            const imgHeight = canvas.height * imgWidth / canvas.width;
            
            // Add the captured image starting below the title
            pdf.addImage(imgData, 'PNG', 20, 50, imgWidth, imgHeight);
            
            pdf.save('vishruta-timesheet.pdf');
        });
    });


    </script>
</body>
</html> 