<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Vishruta Timesheet Management System">
    <title>Timesheet Data</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="navbar">
        <img src="logo.png" alt="Logo" class="navbar-logo">
        <button id="downloadPdfBtn" class="menu-btn download-btn">
            ‚¨áÔ∏è Download
        </button>
    </div>
    <div class="container">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
            <button id="homeBtn" class="home-btn">
                üè† Home
            </button>
            <h2 id="sheetTitle" style="margin: 0;">Employee Timesheet</h2>
            <div style="width: 100px;"></div>
        </div>
        
        <!-- Filter Controls -->
        <div class="filter-container">
            <div class="filter-controls">
                <!-- Name Filter -->
                <div class="filter-group">
                    <label class="filter-label">Name:</label>
                    <select id="nameFilter" class="filter-select" onchange="applyNameFilter()" aria-label="Filter by employee name">
                        <option value="">All</option>
                    </select>
                </div>
                
                <!-- From Date Filter -->
                <div class="filter-group">
                    <label class="filter-label">From Date:</label>
                    <input type="date" id="fromDateFilter" class="filter-select" onchange="applyFromDateFilter()" aria-label="Filter from date" max="">
                </div>
                
                <!-- To Date Filter -->
                <div class="filter-group">
                    <label class="filter-label">To Date:</label>
                    <input type="date" id="toDateFilter" class="filter-select" onchange="applyToDateFilter()" aria-label="Filter to date" max="">
                </div>
            </div>
            
            <!-- Dropdown Menu -->
            <div class="dropdown-menu">
                <button id="menuToggleBtn" class="menu-toggle-btn">
                    üìã Reports ‚ñº
                </button>
                <div id="menuDropdown" class="menu-dropdown">
                    <button id="projectSummaryBtn" class="menu-item-btn">
                        üìã Project Wise
                    </button>
                    <button id="simpleViewBtn" class="menu-item-btn">
                        üìä Date Wise
                    </button>
                </div>
            </div>
        </div>

        <div id="tableContainer">
            <div style="text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 24px; margin-bottom: 10px;">üìä</div>
                <div>Loading timesheet data...</div>
                <div style="font-size: 12px; margin-top: 10px; color: #999;">Please wait while we fetch the latest data</div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Fallback CDN sources in case the primary ones fail -->
    <script>
        // Check if jsPDF loaded successfully, if not try alternative CDN
        if (typeof window.jspdf === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js';
            document.head.appendChild(script);
        }
        
        // Check if html2canvas loaded successfully, if not try alternative CDN
        if (typeof window.html2canvas === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js';
            document.head.appendChild(script);
        }
    </script>
    <script>
        const SHEET_ID = '1_-ZPknnR0N_-iIekrmQE9nKU7Lu2FAA2SQqf2ZXCpYY';
        const RANGE = 'Form Responses 1'; // or 'Sheet1!A1:H'
        const API_KEY = 'AIzaSyBkZ9IVxc5e0s_PJb0ViznAVWUAP-byDWg';

        // Configuration for columns: which to show and their display names
        // The order in this array determines the display order
        const COLUMN_CONFIG = [
            { key: 'Serial', label: 'Serial Number', show: true },
            { key: 'üë§ Choose Your Name ', label: 'Name', show: true },
            { key: 'üìÜ Choose Date', label: 'Date', show: true },
            { key: 'üìÅ Choose Project Code', label: 'Project Code', show: true },
            { key: '‚è∞ Choose Task Start Time', label: 'Start time', show: true },
            { key: '‚è∞ Choose Task End Time', label: 'End Time', show: true },
            { key: 'Hours worked', label: 'Hours worked', show: true },
            { key: 'üè¢ Work Mode', label: 'Mode', show: true },
            // Add more columns here if needed
        ];

        // Remove the fetch for spreadsheet metadata and setting of sheetTitle

        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(RANGE)}?key=${API_KEY}`;

        let allRows = [];
        let filters = {};
        let globalFilters = {
            name: '',
            fromDate: '',
            toDate: ''
        };

        // Helper to normalize date to YYYY-MM-DD (for filtering)
        function normalizeDate(str) {
            if (!str) return '';
            const parts = str.split('/');
            if (parts.length === 3) {
                let [m, d, y] = parts; // Excel format is MM/DD/YYYY
                if (y.length === 4) {
                    return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
                }
            }
            return str;
        }

        // Helper to format date for display as DD-MM-YYYY
        function formatDateForDisplay(str) {
            if (!str) return '';
            const parts = str.split('/');
            if (parts.length === 3) {
                let [m, d, y] = parts; // Excel format is MM/DD/YYYY
                if (y.length === 4) {
                    // Convert MM/DD/YYYY to DD-MM-YYYY for display
                    return `${d.padStart(2, '0')}-${m.padStart(2, '0')}-${y}`;
                }
            }
            return str;
        }

        function renderTable(rows, filters = {}) {
            if (!rows || rows.length === 0) {
                document.getElementById('tableContainer').innerHTML = 'No data found or data format incorrect.';
                return;
            }

            // Find indices of columns to show (excluding 'Timestamp')
            const headerRow = rows[0];
            const colIndices = COLUMN_CONFIG.filter(col => col.key !== 'Serial' && col.show)
                .map(col => headerRow.indexOf(col.key));

            // Apply global filters first
            let filteredRows = rows.slice(1).filter((row, rowIdx) => {
                // Apply name filter
                if (globalFilters.name && row[headerRow.indexOf('üë§ Choose Your Name ')] !== globalFilters.name) {
                    return false;
                }
                
                // Apply from date filter
                if (globalFilters.fromDate) {
                    const dateStr = row[headerRow.indexOf('üìÜ Choose Date')];
                    if (dateStr) {
                        const normalizedDate = normalizeDate(dateStr);
                        if (normalizedDate < globalFilters.fromDate) {
                            return false;
                        }
                    }
                }
                
                // Apply to date filter
                if (globalFilters.toDate) {
                    const dateStr = row[headerRow.indexOf('üìÜ Choose Date')];
                    if (dateStr) {
                        const normalizedDate = normalizeDate(dateStr);
                        if (normalizedDate > globalFilters.toDate) {
                            return false;
                        }
                    }
                }
                

                
                return true;
            });
            
            // Apply column-specific filters
            filteredRows = filteredRows.filter((row, rowIdx) =>
                colIndices.every((colIdx, i) => {
                    const filterVal = filters[colIdx];
                    const startDateFilter = filters[colIdx + '_start'];
                    const endDateFilter = filters[colIdx + '_end'];
                    
                    if (headerRow[colIdx] === 'üìÜ Choose Date') {
                        // Handle date range filtering
                        if (startDateFilter || endDateFilter) {
                            const rowDate = normalizeDate(row[colIdx]);
                            if (!rowDate) return false;
                            
                            const rowDateObj = new Date(rowDate);
                            if (isNaN(rowDateObj.getTime())) return false;
                            
                            if (startDateFilter) {
                                const startDate = new Date(startDateFilter);
                                if (rowDateObj < startDate) return false;
                            }
                            
                            if (endDateFilter) {
                                const endDate = new Date(endDateFilter);
                                if (rowDateObj > endDate) return false;
                            }
                            
                            return true;
                        } else if (filterVal) {
                            // Handle single date filter (backward compatibility)
                            return normalizeDate(row[colIdx]) === filterVal;
                        }
                        return true;
                    }
                    
                    // Handle other column filters
                    if (!filterVal) return true;
                    return row[colIdx] === filterVal;
                })
            );

            // Sort filtered rows by date in ascending order
            const dateColIdx = headerRow.indexOf('üìÜ Choose Date');
            filteredRows.sort((a, b) => {
                const dateA = normalizeDate(a[dateColIdx]);
                const dateB = normalizeDate(b[dateColIdx]);
                
                if (!dateA && !dateB) return 0;
                if (!dateA) return 1;
                if (!dateB) return -1;
                
                return dateA.localeCompare(dateB);
            });

            let html = '<table><thead><tr>';
            // Render dropdown filters and headers
            COLUMN_CONFIG.forEach((col, i) => {
                if (!col.show) return;
                if (col.key === 'Serial') {
                    html += `<th><div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>${col.label}</span>
                                <span></span>
                             </div></th>`;
                } else if (col.key === 'üìÜ Choose Date') {
                    html += `<th><div class="filter-header"><span>${col.label}</span></div></th>`;
                } else if (col.key === '‚è∞ Choose Task Start Time' || col.key === '‚è∞ Choose Task End Time' || col.key === 'Hours worked') {
                    html += `<th><div class="filter-header"><span>${col.label}</span></div></th>`;
                } else if (col.key === 'üë§ Choose Your Name ') {
                    html += `<th><div class="filter-header"><span>${col.label}</span></div></th>`;
                } else {
                    const colIdx = headerRow.indexOf(col.key);
                    const uniqueVals = [...new Set(rows.slice(1).map(row => row[colIdx] || ''))];
                    html += `<th>
                        <div class="filter-header">
                            <span>${col.label}</span>
                            <select class="filter-dropdown" onchange="applyFilter(${colIdx}, this.value)">
                                <option value=""${!filters[colIdx] ? ' selected' : ''}>All</option>
                                ${uniqueVals.map(val =>
                                    `<option value="${val}"${filters[colIdx] === val ? ' selected' : ''}>${val}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </th>`;
                }
            });
            html += '</tr></thead><tbody>';

            // Calculate total hours worked
            let totalHours = 0;
            let totalMinutes = 0;
            
            // Render filtered rows
            filteredRows.forEach((row, i) => {
                html += '<tr>';
                COLUMN_CONFIG.forEach(col => {
                    if (!col.show) return;
                    if (col.key === 'Serial') {
                        html += `<td>${i + 1}</td>`;
                    } else if (col.key === 'Hours worked') {
                        const startIdx = headerRow.indexOf('‚è∞ Choose Task Start Time');
                        const endIdx = headerRow.indexOf('‚è∞ Choose Task End Time');
                        const start = row[startIdx] || '';
                        const end = row[endIdx] || '';

                        function parseTime12h(t) {
                            // Parse time in 12-hour format (e.g., 9:00:00 AM)
                            const [time, modifier] = t.split(' ');
                            let [hours, minutes, seconds] = time.split(':').map(Number);
                            if (modifier === 'PM' && hours !== 12) hours += 12;
                            if (modifier === 'AM' && hours === 12) hours = 0;
                            return hours * 60 + minutes + (seconds ? seconds / 60 : 0);
                        }

                        let total = '';
                        if (start && end) {
                            const startMins = parseTime12h(start);
                            const endMins = parseTime12h(end);
                            let diffMins = endMins - startMins;
                            if (diffMins < 0) diffMins += 24 * 60; // handle overnight
                            const hours = Math.floor(diffMins / 60);
                            const mins = Math.round(diffMins % 60);
                            total = hours + (mins > 0 ? (':' + mins.toString().padStart(2, '0')) : '');
                            
                            // Add to total calculation
                            totalHours += hours;
                            totalMinutes += mins;
                        }
                        html += `<td>${total}</td>`;
                    } else if (col.key === 'üìÜ Choose Date') {
                        const colIdx = headerRow.indexOf(col.key);
                        html += `<td>${formatDateForDisplay(row[colIdx])}</td>`;
                    } else if (col.key === '‚è∞ Choose Task Start Time' || col.key === '‚è∞ Choose Task End Time') {
                        const colIdx = headerRow.indexOf(col.key);
                        const timeValue = row[colIdx] || '';
                        // Add leading zero only to single-digit hours (1-9)
                        const formattedTime = timeValue.replace(/^(\d):/g, '0$1:');
                        html += `<td>${formattedTime}</td>`;
                    } else {
                        const colIdx = headerRow.indexOf(col.key);
                        html += `<td>${row[colIdx]}</td>`;
                    }
                });
                html += '</tr>';
            });
            
            // Add total row
            if (filteredRows.length > 0) {
                // Convert excess minutes to hours
                totalHours += Math.floor(totalMinutes / 60);
                totalMinutes = totalMinutes % 60;
                
                html += '<tr style="background-color: #e8f4fd; font-weight: bold;">';
                COLUMN_CONFIG.forEach(col => {
                    if (!col.show) return;
                    if (col.key === 'Serial') {
                        html += `<td>Total</td>`;
                    } else if (col.key === 'Hours worked') {
                        const totalDisplay = totalHours + (totalMinutes > 0 ? (':' + totalMinutes.toString().padStart(2, '0')) : '');
                        html += `<td>${totalDisplay}</td>`;
                    } else {
                        html += `<td></td>`;
                    }
                });
                html += '</tr>';
            }
            
            html += '</tbody></table>';
            document.getElementById('tableContainer').innerHTML = html;
        }

        window.applyFilter = function(colIdx, value) {
            filters[colIdx] = value;
            renderTable(allRows, filters);
        };

        window.applyDateRangeFilter = function(colIdx, value, type) {
            if (type === 'start') {
                filters[colIdx + '_start'] = value;
            } else if (type === 'end') {
                filters[colIdx + '_end'] = value;
            }
            renderTable(allRows, filters);
        };

        // Global filter functions
        window.applyNameFilter = function() {
            globalFilters.name = document.getElementById('nameFilter').value;
            renderTable(allRows, filters);
        };

        window.applyFromDateFilter = function() {
            globalFilters.fromDate = document.getElementById('fromDateFilter').value;
            renderTable(allRows, filters);
        };

        window.applyToDateFilter = function() {
            globalFilters.toDate = document.getElementById('toDateFilter').value;
            renderTable(allRows, filters);
        };

        // Function to show simple view (serial, name, date, hours worked)
        function showSimpleView() {
            if (!allRows || allRows.length < 2) return;
            
            const headerRow = allRows[0];
            const nameColIdx = headerRow.indexOf('üë§ Choose Your Name ');
            const dateColIdx = headerRow.indexOf('üìÜ Choose Date');
            const startTimeColIdx = headerRow.indexOf('‚è∞ Choose Task Start Time');
            const endTimeColIdx = headerRow.indexOf('‚è∞ Choose Task End Time');
            
            // Apply the same filters as the main table
            let filteredRows = allRows.slice(1).filter((row, rowIdx) => {
                // Apply name filter
                if (globalFilters.name && row[nameColIdx] !== globalFilters.name) {
                    return false;
                }
                
                // Apply from date filter
                if (globalFilters.fromDate) {
                    const dateStr = row[dateColIdx];
                    if (dateStr) {
                        const normalizedDate = normalizeDate(dateStr);
                        if (normalizedDate < globalFilters.fromDate) {
                            return false;
                        }
                    }
                }
                
                // Apply to date filter
                if (globalFilters.toDate) {
                    const dateStr = row[dateColIdx];
                    if (dateStr) {
                        const normalizedDate = normalizeDate(dateStr);
                        if (normalizedDate > globalFilters.toDate) {
                            return false;
                        }
                    }
                }
                
                return true;
            });
            
            // Group by date and collect all projects with their hours for each date
            const dateSummary = {};
            
            filteredRows.forEach(row => {
                const name = row[nameColIdx] || '';
                const originalDate = row[dateColIdx] || '';
                const normalizedDate = normalizeDate(originalDate); // Use normalized date for grouping
                const displayDate = formatDateForDisplay(originalDate); // Use display format for showing
                const projectCode = row[headerRow.indexOf('üìÅ Choose Project Code')] || 'Unknown Project';
                const start = row[startTimeColIdx] || '';
                const end = row[endTimeColIdx] || '';
                
                function parseTime12h(t) {
                    const [time, modifier] = t.split(' ');
                    let [hours, minutes, seconds] = time.split(':').map(Number);
                    if (modifier === 'PM' && hours !== 12) hours += 12;
                    if (modifier === 'AM' && hours === 12) hours = 0;
                    return hours * 60 + minutes + (seconds ? seconds / 60 : 0);
                }
                
                if (start && end && normalizedDate) {
                    const startMins = parseTime12h(start);
                    const endMins = parseTime12h(end);
                    let diffMins = endMins - startMins;
                    if (diffMins < 0) diffMins += 24 * 60;
                    
                    // When "All Names" is selected, group by date + name to show individual employee hours
                    const groupKey = !globalFilters.name || globalFilters.name === '' ? `${normalizedDate}_${name}` : normalizedDate;
                    
                    if (!dateSummary[groupKey]) {
                        dateSummary[groupKey] = {
                            name: name,
                            displayDate: displayDate,
                            projects: {},
                            totalMinutes: 0
                        };
                    }
                    
                    // Add project hours
                    if (!dateSummary[groupKey].projects[projectCode]) {
                        dateSummary[groupKey].projects[projectCode] = 0;
                    }
                    dateSummary[groupKey].projects[projectCode] += diffMins;
                    dateSummary[groupKey].totalMinutes += diffMins;
                }
            });
            
            // Create consolidated report table
            let simpleHtml = '<div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">';
            simpleHtml += '<h3 style="margin-top: 0; color: #333;">Consolidate Report</h3>';
            
            if (Object.keys(dateSummary).length === 0) {
                simpleHtml += '<p>No data found for the selected filters.</p>';
            } else {
                // Check if "All Names" is selected (empty value means all names)
                const showNameColumn = !globalFilters.name || globalFilters.name === '';
                
                // Only show employee name above table if a specific name is selected
                if (!showNameColumn) {
                    const employeeName = Object.values(dateSummary)[0]?.name || 'Unknown';
                    simpleHtml += `<h4 style="margin: 15px 0 10px 0; color: #4285f4; font-size: 18px;">Employee: ${employeeName}</h4>`;
                }
                
                            simpleHtml += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            simpleHtml += '<thead><tr style="background: #4285f4; color: white;">';
            simpleHtml += '<th style="padding: 10px; border: 1px solid #ccc; text-align: center;">Serial</th>';
            if (showNameColumn) {
                simpleHtml += '<th style="padding: 10px; border: 1px solid #ccc; text-align: center;">Name</th>';
            }
            simpleHtml += '<th style="padding: 10px; border: 1px solid #ccc; text-align: center;">Date</th>';
            simpleHtml += '<th style="padding: 10px; border: 1px solid #ccc; text-align: center;">Projects & Hours</th>';
                simpleHtml += '</tr></thead><tbody>';
                
                let grandTotal = 0;
                const sortedDates = Object.keys(dateSummary).sort();
                
                sortedDates.forEach((date, i) => {
                    const summary = dateSummary[date];
                    grandTotal += summary.totalMinutes;
                    
                    // Create project details HTML with table structure for alignment
                    let projectsHtml = '<table style="width: 50%; border-collapse: collapse; margin: 0 auto;">';
                    
                    // Sort projects in the specified order: VES, VEB, INDIRECT, NO-WORK
                    const sortedProjects = Object.entries(summary.projects).sort(([a], [b]) => {
                        const aTrimmed = a.trim().toUpperCase();
                        const bTrimmed = b.trim().toUpperCase();
                        
                        // Check if project names start with our target strings
                        const aStartsWithVES = aTrimmed.startsWith('VES');
                        const aStartsWithVEB = aTrimmed.startsWith('VEB');
                        const aStartsWithINDIRECT = aTrimmed.startsWith('INDIRECT');
                        const aStartsWithNOWORK = aTrimmed.startsWith('NO-WORK');
                        
                        const bStartsWithVES = bTrimmed.startsWith('VES');
                        const bStartsWithVEB = bTrimmed.startsWith('VEB');
                        const bStartsWithINDIRECT = bTrimmed.startsWith('INDIRECT');
                        const bStartsWithNOWORK = bTrimmed.startsWith('NO-WORK');
                        
                        // Assign priorities
                        let aOrder = 5;
                        if (aStartsWithVES) aOrder = 1;
                        else if (aStartsWithVEB) aOrder = 2;
                        else if (aStartsWithINDIRECT) aOrder = 3;
                        else if (aStartsWithNOWORK) aOrder = 4;
                        
                        let bOrder = 5;
                        if (bStartsWithVES) bOrder = 1;
                        else if (bStartsWithVEB) bOrder = 2;
                        else if (bStartsWithINDIRECT) bOrder = 3;
                        else if (bStartsWithNOWORK) bOrder = 4;
                        
                        // If both are in the same priority group, sort by number if applicable
                        if (aOrder === bOrder && aOrder <= 2) { // VES and VEB groups
                            const aNumber = parseInt(aTrimmed.match(/\d+$/)?.[0] || '0');
                            const bNumber = parseInt(bTrimmed.match(/\d+$/)?.[0] || '0');
                            if (aNumber !== bNumber) {
                                return aNumber - bNumber;
                            }
                        }
                        
                        return aOrder - bOrder;
                    });
                    
                    sortedProjects.forEach(([projectCode, minutes], projectIndex) => {
                        const hours = Math.floor(minutes / 60);
                        const mins = Math.round(minutes % 60);
                        const timeDisplay = hours + (mins > 0 ? (':' + mins.toString().padStart(2, '0')) : '');
                        // Alternate background colors for project rows
                        const projectRowBackground = projectIndex % 2 === 0 ? '#e9ecef' : '#f8f9fa';
                        projectsHtml += `<tr style="background: ${projectRowBackground};">
                            <td style="padding: 2px 4px 2px 0; text-align: left; font-weight: bold; color: #4285f4; border: none;">${projectCode} -</td>
                            <td style="padding: 2px 0; text-align: right; font-size: 16px; font-weight: 500; border: none;">${timeDisplay}</td>
                        </tr>`;
                    });
                    
                    // Add total for this date
                    const dateHours = Math.floor(summary.totalMinutes / 60);
                    const dateMinutes = Math.round(summary.totalMinutes % 60);
                    const dateTotal = dateHours + (dateMinutes > 0 ? (':' + dateMinutes.toString().padStart(2, '0')) : '');
                    projectsHtml += `<tr style="border-top: 1px solid #ddd;">
                        <td style="padding: 4px 4px 2px 0; text-align: left; font-weight: bold; color: #333; border: none;">Total:</td>
                        <td style="padding: 4px 0 2px 0; text-align: right; font-weight: bold; color: #333; border: none;">${dateTotal}</td>
                    </tr>`;
                    projectsHtml += '</table>';
                    
                    // Alternate row colors - even rows are darker
                    const rowBackground = i % 2 === 0 ? '#fff' : '#e6e6e6';
                    simpleHtml += `<tr style="background: ${rowBackground};">`;
                    simpleHtml += `<td style="padding: 10px; border: 1px solid #ccc;">${i + 1}</td>`;
                    if (showNameColumn) {
                        simpleHtml += `<td style="padding: 10px; border: 1px solid #ccc;">${summary.name}</td>`;
                    }
                    simpleHtml += `<td style="padding: 10px; border: 1px solid #ccc;">${summary.displayDate}</td>`;
                    simpleHtml += `<td style="padding: 10px; border: 1px solid #ccc;">${projectsHtml}</td>`;
                    simpleHtml += '</tr>';
                });
                
                // Add grand total row
                if (sortedDates.length > 0) {
                    const grandTotalHours = Math.floor(grandTotal / 60);
                    const grandTotalMinutes = Math.round(grandTotal % 60);
                    const grandTotalDisplay = grandTotalHours + (grandTotalMinutes > 0 ? (':' + grandTotalMinutes.toString().padStart(2, '0')) : '');
                    
                    simpleHtml += '<tr style="background: #e8f4fd; font-weight: bold;">';
                    simpleHtml += '<td style="padding: 10px; border: 1px solid #ccc;">Total</td>';
                    if (showNameColumn) {
                        simpleHtml += '<td style="padding: 10px; border: 1px solid #ccc;"></td>';
                    }
                    simpleHtml += '<td style="padding: 10px; border: 1px solid #ccc;"></td>';
                    simpleHtml += `<td style="padding: 10px; border: 1px solid #ccc;">${grandTotalDisplay}</td>`;
                    simpleHtml += '</tr>';
                }
                
                simpleHtml += '</tbody></table>';
            }
            
            simpleHtml += '</div>';
            
            document.getElementById('tableContainer').innerHTML = simpleHtml;
        }

        // Function to show project summary
        function showProjectSummary() {
            if (!allRows || allRows.length < 2) return;
            
            const headerRow = allRows[0];
            const nameColIdx = headerRow.indexOf('üë§ Choose Your Name ');
            const dateColIdx = headerRow.indexOf('üìÜ Choose Date');
            const projectColIdx = headerRow.indexOf('üìÅ Choose Project Code');
            const startTimeColIdx = headerRow.indexOf('‚è∞ Choose Task Start Time');
            const endTimeColIdx = headerRow.indexOf('‚è∞ Choose Task End Time');
            
            // Apply the same filters as the main table
            let filteredRows = allRows.slice(1).filter((row, rowIdx) => {
                // Apply name filter
                if (globalFilters.name && row[nameColIdx] !== globalFilters.name) {
                    return false;
                }
                
                // Apply from date filter
                if (globalFilters.fromDate) {
                    const dateStr = row[dateColIdx];
                    if (dateStr) {
                        const normalizedDate = normalizeDate(dateStr);
                        if (normalizedDate < globalFilters.fromDate) {
                            return false;
                        }
                    }
                }
                
                // Apply to date filter
                if (globalFilters.toDate) {
                    const dateStr = row[dateColIdx];
                    if (dateStr) {
                        const normalizedDate = normalizeDate(dateStr);
                        if (normalizedDate > globalFilters.toDate) {
                            return false;
                        }
                    }
                }
                
                return true;
            });
            
            // Group by project code and calculate total hours
            const projectSummary = {};
            
            filteredRows.forEach(row => {
                const projectCode = row[projectColIdx] || 'Unknown Project';
                const start = row[startTimeColIdx] || '';
                const end = row[endTimeColIdx] || '';
                
                function parseTime12h(t) {
                    const [time, modifier] = t.split(' ');
                    let [hours, minutes, seconds] = time.split(':').map(Number);
                    if (modifier === 'PM' && hours !== 12) hours += 12;
                    if (modifier === 'AM' && hours === 12) hours = 0;
                    return hours * 60 + minutes + (seconds ? seconds / 60 : 0);
                }
                
                if (start && end) {
                    const startMins = parseTime12h(start);
                    const endMins = parseTime12h(end);
                    let diffMins = endMins - startMins;
                    if (diffMins < 0) diffMins += 24 * 60;
                    
                    if (!projectSummary[projectCode]) {
                        projectSummary[projectCode] = 0;
                    }
                    projectSummary[projectCode] += diffMins;
                }
            });
            
            // Create summary table
            let summaryHtml = '<div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">';
            summaryHtml += '<h3 style="margin-top: 0; color: #333;">Project Summary</h3>';
            
            if (Object.keys(projectSummary).length === 0) {
                summaryHtml += '<p>No data found for the selected filters.</p>';
            } else {
                            summaryHtml += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            summaryHtml += '<thead><tr style="background: #4285f4; color: white;">';
            summaryHtml += '<th style="padding: 10px; border: 1px solid #ccc; text-align: center;">Project Code</th>';
            summaryHtml += '<th style="padding: 10px; border: 1px solid #ccc; text-align: center;">Total Hours</th>';
                summaryHtml += '</tr></thead><tbody>';
                
                let grandTotal = 0;
                
                // Sort projects in the specified order: VES, VEB, INDIRECT, NO-WORK
                const sortedProjects = Object.entries(projectSummary).sort(([a], [b]) => {
                    const order = { 'VES': 1, 'VEB': 2, 'INDIRECT': 3, 'NO-WORK': 4 };
                    const aTrimmed = a.trim().toUpperCase();
                    const bTrimmed = b.trim().toUpperCase();
                    
                    // Check if project names start with our target strings
                    const aStartsWithVES = aTrimmed.startsWith('VES');
                    const aStartsWithVEB = aTrimmed.startsWith('VEB');
                    const aStartsWithINDIRECT = aTrimmed.startsWith('INDIRECT');
                    const aStartsWithNOWORK = aTrimmed.startsWith('NO-WORK');
                    
                    const bStartsWithVES = bTrimmed.startsWith('VES');
                    const bStartsWithVEB = bTrimmed.startsWith('VEB');
                    const bStartsWithINDIRECT = bTrimmed.startsWith('INDIRECT');
                    const bStartsWithNOWORK = bTrimmed.startsWith('NO-WORK');
                    
                    // Assign priorities
                    let aOrder = 5;
                    if (aStartsWithVES) aOrder = 1;
                    else if (aStartsWithVEB) aOrder = 2;
                    else if (aStartsWithINDIRECT) aOrder = 3;
                    else if (aStartsWithNOWORK) aOrder = 4;
                    
                    let bOrder = 5;
                    if (bStartsWithVES) bOrder = 1;
                    else if (bStartsWithVEB) bOrder = 2;
                    else if (bStartsWithINDIRECT) bOrder = 3;
                    else if (bStartsWithNOWORK) bOrder = 4;
                    
                    // If both are in the same priority group, sort by number if applicable
                    if (aOrder === bOrder && aOrder <= 2) { // VES and VEB groups
                        const aNumber = parseInt(aTrimmed.match(/\d+$/)?.[0] || '0');
                        const bNumber = parseInt(bTrimmed.match(/\d+$/)?.[0] || '0');
                        if (aNumber !== bNumber) {
                            return aNumber - bNumber;
                        }
                    }
                    
                    return aOrder - bOrder;
                });
                
                sortedProjects.forEach(([project, totalMinutes]) => {
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = Math.round(totalMinutes % 60);
                    const timeDisplay = hours + (minutes > 0 ? (':' + minutes.toString().padStart(2, '0')) : '');
                    grandTotal += totalMinutes;
                    
                    summaryHtml += '<tr style="background: #fff;">';
                    summaryHtml += `<td style="padding: 10px; border: 1px solid #ccc;">${project}</td>`;
                    summaryHtml += `<td style="padding: 10px; border: 1px solid #ccc;">${timeDisplay}</td>`;
                    summaryHtml += '</tr>';
                });
                
                // Add grand total row
                const grandTotalHours = Math.floor(grandTotal / 60);
                const grandTotalMinutes = Math.round(grandTotal % 60);
                const grandTotalDisplay = grandTotalHours + (grandTotalMinutes > 0 ? (':' + grandTotalMinutes.toString().padStart(2, '0')) : '');
                
                summaryHtml += '<tr style="background: #e8f4fd; font-weight: bold;">';
                summaryHtml += '<td style="padding: 10px; border: 1px solid #ccc;">Total</td>';
                summaryHtml += `<td style="padding: 10px; border: 1px solid #ccc;">${grandTotalDisplay}</td>`;
                summaryHtml += '</tr>';
                
                summaryHtml += '</tbody></table>';
            }
            
            summaryHtml += '</div>';
            
            // Show the summary in a modal or replace the table
            document.getElementById('tableContainer').innerHTML = summaryHtml;
        }

        // Function to populate filter dropdowns
        function populateFilterDropdowns() {
            if (!allRows || allRows.length < 2) return;
            
            const headerRow = allRows[0];
            const nameColIdx = headerRow.indexOf('üë§ Choose Your Name ');
            
            // Populate name filter
            const nameFilter = document.getElementById('nameFilter');
            const uniqueNames = [...new Set(allRows.slice(1).map(row => row[nameColIdx] || '').filter(name => name))];
            uniqueNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                nameFilter.appendChild(option);
            });
        }

        // Function to set date limits
        function setDateLimits() {
            const today = new Date().toISOString().split('T')[0]; // Get current date in YYYY-MM-DD format
            document.getElementById('fromDateFilter').max = today;
            document.getElementById('toDateFilter').max = today;
        }

        // Add timeout to fetch request
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
        
        fetch(url, { signal: controller.signal })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                clearTimeout(timeoutId);
                if (!data.values || data.values.length === 0) {
                    throw new Error('No data found in the spreadsheet');
                }
                allRows = data.values;
                filters = {}; // Reset filters
                globalFilters = { name: '', fromDate: '', toDate: '' }; // Reset global filters
                renderTable(allRows, filters);
                populateFilterDropdowns();
                setDateLimits();
            })
            .catch(err => {
                clearTimeout(timeoutId);
                console.error('Error loading timesheet:', err);
                
                let errorMessage = err.message;
                if (err.name === 'AbortError') {
                    errorMessage = 'Request timed out. Please check your internet connection and try again.';
                } else if (err.message.includes('Failed to fetch')) {
                    errorMessage = 'Network error. Please check your internet connection and try again.';
                }
                
                document.getElementById('tableContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #d32f2f; background: #ffebee; border-radius: 8px; margin: 20px 0;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <div style="font-size: 18px; margin-bottom: 10px;">Error Loading Timesheet</div>
                        <div style="font-size: 14px; margin-bottom: 20px;">${errorMessage}</div>
                        <button onclick="location.reload()" style="padding: 10px 20px; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            üîÑ Retry
                        </button>
                    </div>
                `;
            });

    // Menu toggle functionality
    document.getElementById('menuToggleBtn').addEventListener('click', function() {
        const dropdown = document.getElementById('menuDropdown');
        dropdown.classList.toggle('show');
        
        // Change arrow direction
        const arrow = this.textContent.includes('‚ñº') ? '‚ñ≤' : '‚ñº';
        this.textContent = this.textContent.replace(/[‚ñº‚ñ≤]/, arrow);
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('menuDropdown');
        const toggleBtn = document.getElementById('menuToggleBtn');
        
        if (!dropdown.contains(event.target) && !toggleBtn.contains(event.target)) {
            dropdown.classList.remove('show');
            // Reset arrow
            toggleBtn.textContent = toggleBtn.textContent.replace(/[‚ñº‚ñ≤]/, '‚ñº');
        }
    });

    // Project summary button functionality
    document.getElementById('projectSummaryBtn').addEventListener('click', function() {
        showProjectSummary();
        // Close dropdown after selection
        document.getElementById('menuDropdown').classList.remove('show');
        document.getElementById('menuToggleBtn').textContent = document.getElementById('menuToggleBtn').textContent.replace(/[‚ñº‚ñ≤]/, '‚ñº');
    });

    // Simple view button functionality
    document.getElementById('simpleViewBtn').addEventListener('click', function() {
        showSimpleView();
        // Close dropdown after selection
        document.getElementById('menuDropdown').classList.remove('show');
        document.getElementById('menuToggleBtn').textContent = document.getElementById('menuToggleBtn').textContent.replace(/[‚ñº‚ñ≤]/, '‚ñº');
    });

            // Home button functionality
        document.getElementById('homeBtn').addEventListener('click', function() {
            location.reload();
        });

        document.getElementById('downloadPdfBtn').addEventListener('click', function() {
            // Capture the entire page including navbar and logo
            html2canvas(document.body, {
                allowTaint: true,
                useCORS: true,
                scale: 2,
                backgroundColor: '#f2f2f2'
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 0.7);
                const pdf = new window.jspdf.jsPDF({
                    orientation: 'landscape',
                    unit: 'pt',
                    format: 'a4'
                });
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = pageWidth - 40;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                // Add the captured image starting below the title
                pdf.addImage(imgData, 'PNG', 20, 50, imgWidth, imgHeight);
                
                pdf.save('vishruta-timesheet.pdf');
            });
        });


    </script>
</body>
</html> 